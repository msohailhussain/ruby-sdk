-#
-# Copyright 2018, Optimizely and contributors
-#
-# Licensed under the Apache License, Version 2.0 (the "License");
-# you may not use this file except in compliance with the License.
-# You may obtain a copy of the License at
-#
-#    http://www.apache.org/licenses/LICENSE-2.0
-#
-# Unless required by applicable law or agreed to in writing, software
-# distributed under the License is distributed on an "AS IS" BASIS,
-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-# See the License for the specific language governing permissions and
-# limitations under the License.
-#
.container
  / Example row of columns
  = render "shared/tabs"
  = render partial: "cart", locals: { cart: @cart, discount_percentage: @discount_percentage, receipt: false}
  #receiptModal.modal.fade.bd-example-modal-lg{"aria-hidden" => "true", "aria-labelledby" => "exampleModalLabel", :role => "dialog", :tabindex => "-1"}
    .modal-dialog.modal-lg{:role => "document"}
      .modal-content
        .modal-header.card-header
          %h5#exampleModalLongTitle.modal-title Reciept # xxx
          %button.close#closeCartModal{"aria-label" => "Close", "data-dismiss" => "modal", :type => "button"}
            %span{"aria-hidden" => "true"} Ã—
        .modal-body.card-block#receiptBody
        .modal-footer
          = link_to "OK",
              checkout_cart_path(user_id: @current_user['user_id']),
              method: :get, class:"btn btn-info btn-lg checkout"


  :coffeescript

    DiscountRate = #{@discount_percentage * 0.01}
    fadeTime = 300
    userId = "#{@current_user['user_id']}"
    ### Assign actions ###

    ### Recalculate cart ###
    updateCart = (params) ->
    recalculateCart = ->
      subtotal = 0

      ### Sum up row totals ###

      $('.product').each ->
        subtotal += parseFloat($(this).children('.product-line-price').text())
      ### Calculate totals ###

      discount = subtotal * DiscountRate
      total = subtotal - discount

      ### Update totals display ###

      $('.totals-value').fadeOut fadeTime, ->
        $('#cart-subtotal').html subtotal.toFixed(2)
        $('#cart-discount').html discount.toFixed(2)
        $('#cart-total').html total.toFixed(2)
        if total == 0
          $('.checkout').fadeOut fadeTime
        else
          $('.checkout').fadeIn fadeTime
        $('.totals-value').fadeIn fadeTime

    ### Update quantity ###

    updateQuantity = (quantityInput) ->

      ### Calculate line price ###
      product_id = quantityInput.getAttribute('product_id')
      productRow = $(quantityInput).parent().parent()
      price = parseFloat(productRow.children('.product-price').text())
      quantity = $(quantityInput).val()
      linePrice = price * quantity
      params = {product_id: product_id, quantity: quantity}
      $.ajax
        url: '/demo/'+userId+'/update_cart.json'
        type: 'PUT'
        data: params
        success: (result) ->
          if result.success == true
            ### Update line price display and recalc cart totals ###
            productRow.children('.product-line-price').each ->
              $(this).fadeOut fadeTime, ->
                $(this).text linePrice.toFixed(2)
                recalculateCart()
                $(this).fadeIn fadeTime
          else
            alert result.message
        error: (error) ->
          return false


    ### Remove item from cart ###

    removeItem = (removeButton) ->

      ### Remove row from DOM and recalc cart total ###

      productRow = $(removeButton).parent().parent()
      product_id = removeButton.getAttribute('product_id')
      params = {product_id: product_id, quantity: 0}
      $.ajax
        url: '/demo/'+userId+'/update_cart.json'
        type: 'PUT'
        data: params
        success: (result) ->
          if result.success == true
            productRow.slideUp fadeTime, ->
              productRow.remove()
              recalculateCart()
          else
            alert result.message
        error: (error) ->
          return false

    $('.product-quantity input').change ->
      updateQuantity this

    $('.product-removal button').click ->
      removeItem this

    $('#closeCartModal').click ->
      $('#receiptBody').html("")